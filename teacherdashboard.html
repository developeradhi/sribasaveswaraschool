<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Teacher Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      margin: 2rem auto;
      max-width: 960px;
      background: #f4f9ff;
      color: #23395d;
    }
    h1 {
      font-family: 'Roboto Mono', monospace;
      font-weight: 700;
      font-size: 2.2rem;
      margin-bottom: 1rem;
      text-align: center;
      color: #2562eb;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1rem;
      justify-content: space-between;
    }
    select, input[type="text"], button {
      padding: 0.5em 1em;
      font-size: 1rem;
      border-radius: 6px;
      border: 1.5px solid #aac6fb;
      transition: border-color 0.3s ease;
    }
    select:focus, input[type="text"]:focus {
      border-color: #2562eb;
      outline: none;
    }
    button {
      cursor: pointer;
      background-color: #2562eb;
      color: #fff;
      border: none;
      font-weight: 600;
      transition: background-color 0.3s ease;
      border-radius: 6px;
    }
    button:hover {
      background-color: #1946b5;
    }
    #studentTableContainer {
      overflow-x: auto;
      border-radius: 10px;
      box-shadow: 0 8px 24px rgba(37, 98, 235, 0.16);
      background: white;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 700px;
    }
    th, td {
      text-align: center;
      padding: 8px 10px;
      border: 1px solid #e1ecfb;
      font-size: 0.95rem;
      vertical-align: middle;
    }
    th {
      background-color: #2562eb;
      color: white;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    tr:nth-child(even) {
      background-color: #f7faff;
    }
    input[type="number"], input[type="text"], input[type="date"] {
      width: 60px;
      padding: 4px 6px;
      font-size: 0.9rem;
      border: 1px solid #aac6fb;
      border-radius: 4px;
      box-sizing: border-box;
    }
    #searchInput {
      flex-grow: 1;
      min-width: 200px;
      padding: 8px 12px;
      font-size: 1rem;
      border: 1.5px solid #aac6fb;
      border-radius: 6px;
      box-sizing: border-box;
    }
    #infoMessage {
      margin-top: 0.8rem;
      font-weight: 600;
      text-align: center;
      color: #2562eb;
    }
    @media (max-width: 700px) {
      #studentTableContainer {
        overflow-x: scroll;
      }
      input[type="number"], input[type="text"], input[type="date"] {
        width: 50px;
      }
      .controls {
        flex-direction: column;
        gap: 0.75rem;
      }
      #searchInput {
        min-width: 100%;
      }
    }
  </style>
</head>
<body>
  <h1>Teacher Dashboard</h1>
  <div class="controls">
    <select id="classSelect" aria-label="Select Class">
      <option value="">Select Class</option>
    </select>
    <input type="text" id="searchInput" placeholder="Search by Roll No or Name" aria-label="Search Students"/>
    <button id="addRowBtn" aria-label="Add Student">Add Student</button>
    <button id="saveBtn" aria-label="Save Changes">Save Changes</button>
    <button id="importBtn" aria-label="Import CSV">Import CSV</button>
    <button id="exportBtn" aria-label="Export CSV">Export CSV</button>
  </div>
  <input type="file" id="fileInput" accept=".csv,text/csv" style="display:none;" />
  <div id="infoMessage" role="alert"></div>
  <div id="studentTableContainer">
    <table id="studentTable" aria-live="polite">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get('token');
  const username = urlParams.get('user');
  const apiBase = location.origin + location.pathname.replace(/\/exec(?:.*)$/, '') + '/exec';

  const classSelect = document.getElementById('classSelect');
  const searchInput = document.getElementById('searchInput');
  const addRowBtn = document.getElementById('addRowBtn');
  const saveBtn = document.getElementById('saveBtn');
  const importBtn = document.getElementById('importBtn');
  const exportBtn = document.getElementById('exportBtn');
  const fileInput = document.getElementById('fileInput');
  const infoMessage = document.getElementById('infoMessage');
  const table = document.getElementById('studentTable');
  const thead = table.querySelector('thead');
  const tbody = table.querySelector('tbody');

  let studentsData = [];
  let originalData = [];
  let headers = [];
  let currentClass = '';

  async function fetchClasses(){
    // Since no direct API for classes, hardcode or implement backend endpoint for list of classes
    // For demo:
    return (await (await fetch(apiBase, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ action: 'list_classes', token, username })
    })).json()).classes || [];
  }

  async function fetchClassData(className){
    infoMessage.textContent = `Loading ${className} data...`;
    try {
      const resp = await fetch(apiBase, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'classfetch', token, username, className })
      });
      const data = await resp.json();
      if(data.status === 'ok'){
        headers = data.headers;
        studentsData = data.students;
        originalData = JSON.parse(JSON.stringify(data.students)); // deep copy
        infoMessage.textContent = '';
        renderTable(headers, studentsData);
      } else{
        infoMessage.textContent = `Error: ${data.message || 'Failed to load data'}`;
      }
    } catch(e){
      infoMessage.textContent = `Network error: ${e.message}`;
    }
  }

  function renderTable(headers, data){
    // Render headers
    thead.innerHTML = '';
    const trHead = document.createElement('tr');
    headers.forEach(h => {
      const th = document.createElement('th');
      th.textContent = h;
      trHead.appendChild(th);
    });
    thead.appendChild(trHead);

    // Render rows
    tbody.innerHTML = '';
    data.forEach((row, idx) => {
      const tr = document.createElement('tr');
      row.forEach((cell, col) => {
        const td = document.createElement('td');
        if(col < 4){
          // Roll No, Name, DOB, Email: text/date inputs
          const input = document.createElement('input');
          input.type = (col === 2) ? 'date' : 'text';
          input.value = cell || '';
          input.dataset.row = idx;
          input.dataset.col = col;
          input.addEventListener('change', onCellEdit);
          td.appendChild(input);
        } else {
          // Marks: numeric inputs
          const input = document.createElement('input');
          input.type = 'number';
          input.min = 0;
          input.max = 100;
          input.step = 1;
          input.value = cell || '';
          input.dataset.row = idx;
          input.dataset.col = col;
          input.addEventListener('change', onCellEdit);
          td.appendChild(input);
        }
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  }

  function onCellEdit(e){
    const row = parseInt(e.target.dataset.row);
    const col = parseInt(e.target.dataset.col);
    let val = e.target.value;

    if(col === 2){
      // Validate date format yyyy-mm-dd
      if(!/^\d{4}-\d{2}-\d{2}$/.test(val)){
        alert('Please enter date in YYYY-MM-DD format');
        e.target.value = studentsData[row][col];
        return;
      }
    } else if(col >= 4){
      val = Number(val);
      if(isNaN(val) || val < 0 || val > 100){
        alert('Please enter valid marks between 0 and 100');
        e.target.value = studentsData[row][col];
        return;
      }
    } else {
      val = val.trim();
    }

    studentsData[row][col] = val;
  }

  function filterTable(term){
    const lower = term.toLowerCase();
    const filtered = studentsData.filter(r => 
      (r[0] && r[0].toString().toLowerCase().includes(lower)) || (r[1] && r[1].toString().toLowerCase().includes(lower))
    );
    renderTable(headers, filtered);
  }

  searchInput.addEventListener('input', () => filterTable(searchInput.value));

  classSelect.addEventListener('change', () => {
    currentClass = classSelect.value;
    if(currentClass){
      fetchClassData(currentClass);
    } else{
      tbody.innerHTML = '';
      thead.innerHTML = '';
      infoMessage.textContent = '';
    }
  });

  addRowBtn.addEventListener('click', () => {
    if(!currentClass){
      alert('Please select a class first!');
      return;
    }
    const newRow = new Array(headers.length).fill('');
    studentsData.push(newRow);
    renderTable(headers, studentsData);
  });

  saveBtn.addEventListener('click', async () => {
    if(!currentClass) return alert('Select a class first!');

    infoMessage.textContent = 'Saving changes...';
    try {
      const resp = await fetch(apiBase, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'classupdate',
          token,
          username,
          className: currentClass,
          updates: studentsData
        })
      });
      const data = await resp.json();
      if(data.status === 'ok'){
        infoMessage.textContent = 'Changes saved successfully!';
        originalData = JSON.parse(JSON.stringify(studentsData));
      } else {
        infoMessage.textContent = `Error saving changes: ${data.message || 'Unknown error'}`;
      }
    } catch(e){
      infoMessage.textContent = `Network error: ${e.message}`;
    }
  });

  importBtn.addEventListener('click', () => {
    if(!currentClass){
      alert('Please select a class first!');
      return;
    }
    fileInput.click();
  });

  fileInput.addEventListener('change', () => {
    const file = fileInput.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      const text = e.target.result;
      const parsed = parseCSV(text);
      if(parsed && parsed.length && parsed[0].length === headers.length){
        // Remove header row, accept rest
        studentsData = parsed.slice(1);
        renderTable(headers, studentsData);
        infoMessage.textContent = `Imported ${studentsData.length} rows successfully. Don't forget to Save!`;
      } else {
        alert('CSV format invalid or column count mismatch.');
      }
      fileInput.value = null;
    }
    reader.readAsText(file);
  });

  exportBtn.addEventListener('click', () => {
    if(!studentsData.length) return alert('No data to export.');
    let csv = headers.join(',') + '\n';
    studentsData.forEach(row => {
      csv += row.map(cell =>
        `"${String(cell).replace(/"/g, '""')}"`
      ).join(',') + '\n';
    });
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${currentClass || 'class'}-students.csv`;
    a.click();
    URL.revokeObjectURL(url);
  });

  function parseCSV(str) {
    const rows = str.split(/\r?\n/).filter(l => l.trim() !== '');
    return rows.map(r => r.split(',').map(c => c.trim()));
  }

  (async () => {
    if(!token || !username){
      document.body.innerHTML = '<h2>Please login via Admin portal first.</h2>';
      return;
    }
    const classes = await fetchClasses();
    classSelect.innerHTML = '<option value="">Select Class</option>';
    classes.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c;
      opt.textContent = c;
      classSelect.appendChild(opt);
    });
  })();

</script>
</body>
</html>

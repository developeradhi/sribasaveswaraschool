<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Login | Sri Basaveswara School</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <style>body { font-family: 'Inter', sans-serif; } .nav-item.active { background: #1f2937; border-right: 3px solid #3b82f6; }</style>
</head>
<body class="bg-gray-100 h-screen flex overflow-hidden">

    <!-- ========================== -->
    <!-- 1. LOGIN SCREEN (Visible)  -->
    <!-- ========================== -->
    <div id="login-view" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-2xl mx-auto mb-4">S</div>
                <h1 class="text-2xl font-bold text-gray-900">Staff Workspace</h1>
                <p class="text-sm text-gray-500">Secure ERP Access</p>
            </div>
            
            <form id="login-form" class="space-y-5">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Username</label>
                    <input id="uid" type="text" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Password</label>
                    <input id="upass" type="password" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition">
                </div>
                <button type="submit" id="btn-login" class="w-full bg-gray-900 text-white py-3 rounded-lg font-bold hover:bg-gray-800 transition shadow-lg">
                    Login to Dashboard
                </button>
            </form>

            <div id="login-msg" class="mt-4 p-3 bg-red-50 text-red-600 text-sm rounded-lg hidden text-center"></div>

            <div class="mt-8 text-center pt-6 border-t">
                <a href="index.html" class="text-sm text-gray-500 hover:text-gray-900">&larr; Back to Student Portal</a>
            </div>
        </div>
    </div>

    <!-- ========================== -->
    <!-- 2. DASHBOARD (Hidden)      -->
    <!-- ========================== -->
    <div id="dash-view" class="hidden flex w-full h-full">
        
        <!-- Sidebar -->
        <aside class="w-64 bg-gray-900 text-gray-300 flex flex-col">
            <div class="h-16 flex items-center px-6 border-b border-gray-800 font-bold text-white tracking-wider gap-3">
                <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center text-sm">SBS</div> ERP
            </div>

            <nav class="flex-1 py-6 space-y-1 overflow-y-auto">
                <p class="px-6 text-xs font-bold text-gray-500 uppercase mb-2 tracking-wider">Modules</p>
                
                <a onclick="render('dashboard')" class="nav-item active cursor-pointer flex items-center px-6 py-3 hover:bg-gray-800 hover:text-white transition">
                    <i data-feather="grid" class="w-4 h-4 mr-3"></i> Overview
                </a>
                <a onclick="render('admission')" class="nav-item cursor-pointer flex items-center px-6 py-3 hover:bg-gray-800 hover:text-white transition">
                    <i data-feather="user-plus" class="w-4 h-4 mr-3"></i> Admission
                </a>
                <a onclick="render('exams')" class="nav-item cursor-pointer flex items-center px-6 py-3 hover:bg-gray-800 hover:text-white transition">
                    <i data-feather="edit-3" class="w-4 h-4 mr-3"></i> Exams & Marks
                </a>
                <a onclick="render('communicate')" class="nav-item cursor-pointer flex items-center px-6 py-3 hover:bg-gray-800 hover:text-white transition">
                    <i data-feather="mail" class="w-4 h-4 mr-3"></i> Messaging
                </a>

                <div id="admin-menu" class="hidden mt-6 pt-6 border-t border-gray-800">
                    <p class="px-6 text-xs font-bold text-gray-500 uppercase mb-2 tracking-wider">Admin Only</p>
                    <a onclick="render('users')" class="nav-item cursor-pointer flex items-center px-6 py-3 hover:bg-gray-800 hover:text-white transition">
                        <i data-feather="users" class="w-4 h-4 mr-3"></i> Manage Staff
                    </a>
                </div>
            </nav>

            <div class="p-4 border-t border-gray-800 bg-gray-900">
                <div class="flex items-center gap-3 mb-3 px-2">
                    <div class="w-8 h-8 bg-gray-700 rounded-full flex items-center justify-center text-xs text-white font-bold" id="u-avatar">U</div>
                    <div class="overflow-hidden">
                        <p class="text-sm font-medium text-white truncate" id="u-name">User</p>
                        <p class="text-xs text-gray-500 truncate" id="u-role">Role</p>
                    </div>
                </div>
                <button onclick="logout()" class="w-full py-2 border border-gray-700 rounded text-xs hover:bg-red-600 hover:text-white hover:border-red-600 transition">Sign Out</button>
            </div>
        </aside>

        <!-- Main Workspace -->
        <main class="flex-1 flex flex-col min-w-0 bg-gray-50">
            <header class="h-16 bg-white border-b flex items-center justify-between px-8 shadow-sm sticky top-0 z-10">
                <h2 class="text-xl font-bold text-gray-800" id="page-title">Overview</h2>
                <div class="text-sm text-gray-500" id="date-display"></div>
            </header>
            
            <div id="workspace" class="flex-1 p-8 overflow-y-auto">
                <!-- Content loads here dynamically -->
            </div>
        </main>
    </div>

    <script>
        // ==========================================
        // ⚠️ PASTE YOUR GOOGLE SCRIPT URL HERE
        // ==========================================
        const API_URL = "https://script.google.com/macros/s/AKfycbxiWmSrauE22lSfkjrcNkFWkX0yawPKbgGfskYeNpFP1zXvfw8IhFoQ6_vykfXoYHHcFg/exec"; 

        // --- LOGIC ---
        document.getElementById('date-display').innerText = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

        // 1. Login Handler
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-login');
            const msg = document.getElementById('login-msg');
            
            btn.innerHTML = `<i data-feather="loader" class="animate-spin inline mr-2"></i> Verifying...`;
            feather.replace();
            btn.disabled = true;
            msg.classList.add('hidden');

            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ 
                        action: 'login', 
                        id: document.getElementById('uid').value, 
                        password: document.getElementById('upass').value 
                    })
                }).then(r => r.json());

                if(res.status === 'success' && res.type === 'staff') {
                    // Success: Switch to Dashboard
                    document.getElementById('login-view').classList.add('hidden');
                    document.getElementById('dash-view').classList.remove('hidden');
                    
                    // Set User Info
                    document.getElementById('u-name').innerText = res.name;
                    document.getElementById('u-role').innerText = res.role;
                    document.getElementById('u-avatar').innerText = res.name.charAt(0);

                    // Show Admin Menu if needed
                    if(['Super Admin', 'Admin', 'Principal'].includes(res.role)) {
                        document.getElementById('admin-menu').classList.remove('hidden');
                    }
                    
                    render('dashboard'); // Load default view
                } else {
                    throw new Error(res.message || "Invalid Credentials");
                }
            } catch(err) {
                msg.innerText = err.message;
                msg.classList.remove('hidden');
                btn.innerText = "Login to Dashboard";
                btn.disabled = false;
            }
        });

        // 2. Navigation Renderer
        const views = {
            dashboard: `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <p class="text-sm text-gray-500 font-medium">Total Students</p>
                        <h3 class="text-3xl font-bold text-gray-900 mt-2">1,200+</h3>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <p class="text-sm text-gray-500 font-medium">Attendance Today</p>
                        <h3 class="text-3xl font-bold text-green-600 mt-2">94%</h3>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <p class="text-sm text-gray-500 font-medium">Pending Actions</p>
                        <h3 class="text-3xl font-bold text-orange-500 mt-2">5</h3>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-10 text-center">
                    <h3 class="text-xl font-bold text-gray-900">Welcome to the Staff Console</h3>
                    <p class="text-gray-500 mt-2">Please select a module from the sidebar to begin your work.</p>
                </div>`,

            admission: `
                <div class="bg-white p-8 rounded-xl shadow-sm border max-w-4xl mx-auto">
                    <h3 class="text-lg font-bold text-gray-900 mb-6 pb-4 border-b">New Student Registration</h3>
                    <form onsubmit="apiAction(event, 'addStudent')" class="grid grid-cols-2 gap-6">
                        <div><label class="text-xs font-bold text-gray-500 uppercase">Roll No</label><input name="RollNumber" required class="w-full p-3 border rounded bg-gray-50 mt-1"></div>
                        <div><label class="text-xs font-bold text-gray-500 uppercase">Full Name</label><input name="Name" required class="w-full p-3 border rounded bg-gray-50 mt-1"></div>
                        <div><label class="text-xs font-bold text-gray-500 uppercase">Class</label><input name="Class" placeholder="e.g. 10" required class="w-full p-3 border rounded bg-gray-50 mt-1"></div>
                        <div><label class="text-xs font-bold text-gray-500 uppercase">Section</label><input name="Section" placeholder="e.g. A" required class="w-full p-3 border rounded bg-gray-50 mt-1"></div>
                        <div><label class="text-xs font-bold text-gray-500 uppercase">DOB</label><input name="DOB" type="date" required class="w-full p-3 border rounded bg-gray-50 mt-1"></div>
                        <div><label class="text-xs font-bold text-gray-500 uppercase">Gender</label><select name="Gender" class="w-full p-3 border rounded bg-gray-50 mt-1"><option>Male</option><option>Female</option></select></div>
                        <div class="col-span-2"><label class="text-xs font-bold text-gray-500 uppercase">Parent Email (Login ID)</label><input name="Email" type="email" required class="w-full p-3 border rounded bg-yellow-50 border-yellow-200 mt-1"></div>
                        <div><label class="text-xs font-bold text-gray-500 uppercase">Father Name</label><input name="FatherName" required class="w-full p-3 border rounded bg-gray-50 mt-1"></div>
                        <div><label class="text-xs font-bold text-gray-500 uppercase">Mother Name</label><input name="MotherName" required class="w-full p-3 border rounded bg-gray-50 mt-1"></div>
                        <div class="col-span-2 pt-4">
                            <button class="w-full bg-blue-600 text-white py-3 rounded font-bold hover:bg-blue-700 transition">Admit Student</button>
                        </div>
                    </form>
                </div>`,

            exams: `
                <div class="max-w-4xl mx-auto space-y-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border">
                        <h3 class="font-bold text-gray-900 mb-4">1. Create New Exam Session</h3>
                        <div class="flex gap-4">
                            <input id="new-exam" placeholder="Exam Name (e.g. Final 2025)" class="flex-1 p-3 border rounded-lg">
                            <button onclick="createExam()" class="bg-indigo-600 text-white px-6 rounded-lg font-medium hover:bg-indigo-700">Create</button>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border">
                        <h3 class="font-bold text-gray-900 mb-4">2. Enter Marks</h3>
                        <div class="grid grid-cols-3 gap-4 mb-6">
                            <input id="mark-exam" placeholder="Exam Name" class="p-3 border rounded-lg">
                            <input id="mark-class" placeholder="Class (e.g. 10)" class="p-3 border rounded-lg">
                            <button onclick="loadStudents()" class="bg-gray-900 text-white rounded-lg font-medium">Fetch Student List</button>
                        </div>
                        <div id="marks-area" class="hidden">
                            <!-- Table injects here -->
                        </div>
                    </div>
                </div>`,

            users: `
                 <div class="bg-white p-8 rounded-xl shadow-sm border max-w-2xl mx-auto">
                    <h3 class="text-lg font-bold text-gray-900 mb-6 pb-4 border-b">Add Staff Member</h3>
                    <form onsubmit="apiAction(event, 'addStaff')" class="space-y-5">
                        <div><label class="text-xs font-bold text-gray-500 uppercase">Full Name</label><input name="fullname" required class="w-full p-3 border rounded mt-1"></div>
                        <div><label class="text-xs font-bold text-gray-500 uppercase">Username</label><input name="username" required class="w-full p-3 border rounded mt-1"></div>
                        <div><label class="text-xs font-bold text-gray-500 uppercase">Password</label><input name="password" required class="w-full p-3 border rounded mt-1"></div>
                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase">Role</label>
                            <select name="role" class="w-full p-3 border rounded mt-1">
                                <option>Teacher</option><option>HOD</option><option>Principal</option><option>Admin</option>
                            </select>
                        </div>
                        <button class="w-full bg-purple-600 text-white py-3 rounded font-bold hover:bg-purple-700 mt-4">Create Account</button>
                    </form>
                </div>`,
            
            communicate: `
                <div class="bg-white p-8 rounded-xl shadow-sm border max-w-3xl mx-auto">
                    <h3 class="text-lg font-bold text-gray-900 mb-6">Send Email Blast</h3>
                    <form onsubmit="apiAction(event, 'sendMessage')" class="space-y-5">
                        <div class="grid grid-cols-2 gap-6">
                            <div><label class="text-xs font-bold text-gray-500 uppercase">Target Class</label><input name="className" placeholder="e.g. 10" required class="w-full p-3 border rounded mt-1"></div>
                            <div><label class="text-xs font-bold text-gray-500 uppercase">Subject</label><input name="subject" placeholder="Subject Line" required class="w-full p-3 border rounded mt-1"></div>
                        </div>
                        <div><label class="text-xs font-bold text-gray-500 uppercase">Message</label><textarea name="message" rows="5" required class="w-full p-3 border rounded mt-1"></textarea></div>
                        <button class="w-full bg-indigo-600 text-white py-3 rounded font-bold hover:bg-indigo-700">Send to Parents</button>
                    </form>
                </div>`
        };

        function render(view) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            // Highlight logic skipped for brevity, works on click
            document.getElementById('page-title').innerText = view.charAt(0).toUpperCase() + view.slice(1);
            document.getElementById('workspace').innerHTML = views[view] || `<div class="text-center mt-20 text-gray-400">Under Construction</div>`;
            feather.replace();
        }

        function logout() {
            if(confirm("Are you sure you want to logout?")) {
                window.location.href = 'index.html';
            }
        }

        // --- API FUNCTIONS ---
        async function apiAction(e, action) {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const originalText = btn.innerText;
            btn.innerText = "Processing...";
            btn.disabled = true;

            const data = Object.fromEntries(new FormData(e.target));
            try {
                const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action, ...data }) }).then(r => r.json());
                alert(res.message);
                if(res.status === 'success') e.target.reset();
            } catch(err) { alert("Error: " + err.message); }
            finally { btn.innerText = originalText; btn.disabled = false; }
        }

        async function createExam() {
            const name = document.getElementById('new-exam').value;
            if(!name) return alert("Enter Name");
            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'createExam', examName: name }) }).then(r=>r.json());
            alert(res.message);
        }

        async function loadStudents() {
            const cls = document.getElementById('mark-class').value;
            const exam = document.getElementById('mark-exam').value;
            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'getStudentsByClass', className: cls }) }).then(r=>r.json());

            if(res.data && res.data.length) {
                document.getElementById('marks-area').innerHTML = `
                    <table class="w-full text-left text-sm border mb-4 mt-4">
                        <thead class="bg-gray-100"><tr><th class="p-3">Roll</th><th class="p-3">Name</th><th class="p-3">Subject</th><th class="p-3">Marks</th></tr></thead>
                        <tbody id="m-body">${res.data.map(s => `
                            <tr>
                                <td class="p-3 border-b">${s.RollNumber}</td>
                                <td class="p-3 border-b font-bold">${s.Name}</td>
                                <td class="p-3 border-b"><input class="sub w-full bg-gray-50 p-2 border rounded" placeholder="Subject"></td>
                                <td class="p-3 border-b"><input class="score w-full bg-gray-50 p-2 border rounded" placeholder="Marks" data-roll="${s.RollNumber}"></td>
                            </tr>`).join('')}</tbody>
                    </table>

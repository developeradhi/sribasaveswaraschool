<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sri Basaveswara School - Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; transition: background-color 0.3s, color 0.3s; }
        .font-playfair { font-family: 'Playfair Display', serif; }
        .fade-in { animation: fadeIn 0.5s ease-in-out forwards; opacity: 0; }
        .fade-in-up { animation: fadeInUp 0.6s ease-in-out forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .modal-content { transition: transform 0.3s ease; }
        
        /* Dark Mode Styles */
        .dark, .dark body { background-color: #111827; color: #e5e7eb; }
        .dark .bg-white { background-color: #1f2937; }
        .dark .bg-gray-50 { background-color: #1f2937; }
        .dark .bg-gray-100 { background-color: #374151; }
        .dark .bg-gray-200 { background-color: #374151; }
        .dark .text-gray-800 { color: #f9fafb; }
        .dark .text-gray-600 { color: #d1d5db; }
        .dark .text-gray-500 { color: #9ca3af; }
        .dark .border-gray-200, .dark .border-gray-300, .dark .border-gray-700 { border-color: #374151; }
        .dark input, .dark select { background-color: #374151; border-color: #4b5563; color: #f9fafb; }
        .dark .dark-mode-icon { display: none; }
        .dark .light-mode-icon { display: inline-block; }
        .light-mode-icon { display: none; }

        .certificate { 
            border: 10px solid; 
            border-image-slice: 1; 
            border-width: 10px; 
            border-image-source: linear-gradient(to left, #743ad5, #d53a9d); 
            position: relative;
        }
        .certificate-banner {
            background-size: cover;
            background-position: center;
            color: white;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200">
    <div id="app"></div>
    <div id="modal-container" class="fixed inset-0 z-50"></div>

    <script>
    // --- CONFIGURATION ---
    const SCRIPT_URL = "https://script.google.com/macros/library/d/1T3p8_FfVa-GXBdSSvJFz7uaIIyIKPbdvmrT59S08hP3_WPZuWq9aU9WL/8";

    // --- APPLICATION STATE ---
    const state = {
        currentPage: 'studentPortal', user: null, dashboardData: {}, currentDashboardView: '', theme: 'light',
        schoolAssets: { logo: 'https://i.imgur.com/sC21n6s.png', signature: 'https://i.imgur.com/bZtA8f0.png', banner: 'https://i.imgur.com/8i2A8sH.jpg' },
    };

    // --- API COMMUNICATION ---
    async function apiCall(action, method = 'POST', body = null) {
        const url = `${SCRIPT_URL}?action=${action}`;
        document.body.style.cursor = 'wait';
        try {
            const response = await fetch(url, { method: 'POST', mode: 'cors', body: JSON.stringify(body), headers: { 'Content-Type': 'application/json' } });
            const result = await response.json();
            if (result.status === 'error') throw new Error(result.message);
            return result;
        } catch (error) {
            showModal('Error', `<p>An API error occurred: ${error.message}</p>`);
            throw error;
        } finally { document.body.style.cursor = 'default'; }
    }

    // --- TEMPLATES (DEFINED UPFRONT) ---
    const templates = {
        studentPortal: () => `
            <div class="min-h-screen flex flex-col items-center justify-center p-4">
                <div class="w-full max-w-4xl mx-auto">
                    <header class="text-center mb-8 fade-in-up">
                        <img src="${state.schoolAssets.logo}" alt="School Logo" class="h-24 mx-auto mb-4" id="main-logo">
                        <h1 class="font-playfair text-4xl md:text-5xl font-bold">St. Xavier's School</h1>
                        <p class="text-gray-600 dark:text-gray-400 mt-2">Digital Results Portal</p>
                    </header>
                    <div id="result-form-section" class="w-full max-w-lg mx-auto bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg fade-in-up" style="animation-delay: 0.2s;">
                        <h2 class="text-2xl font-semibold text-center mb-6">Check Your Exam Result</h2>
                        <form id="result-form" class="space-y-4">
                            <div><label for="roll-no" class="block text-sm font-medium mb-1">Roll Number</label><input type="text" id="roll-no" required class="w-full p-3 rounded-lg border"></div>
                            <div><label for="dob" class="block text-sm font-medium mb-1">Date of Birth</label><input type="date" id="dob" required class="w-full p-3 rounded-lg border"></div>
                            <button type="submit" id="submit-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg flex items-center justify-center">
                                <span id="submit-btn-text">Get Result</span>
                                <div id="submit-spinner" class="hidden w-5 h-5 ml-3 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                            </button>
                        </form>
                    </div>
                    <div id="result-display-section" class="w-full max-w-4xl mx-auto mt-8 hidden"></div>
                    <section id="about-school" class="mt-12 bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg fade-in-up" style="animation-delay: 0.4s;">
                        <h3 class="font-playfair text-3xl font-bold text-center mb-6">About Our School</h3>
                        <div class="text-center text-gray-600 dark:text-gray-400 space-y-4">
                            <p>Sri Basaveswara School, established in 2023, is a beacon of excellence in education...</p>
                        </div>
                    </section>
                    <footer class="text-center mt-8 text-sm text-gray-500 dark:text-gray-400"><p>&copy; ${new Date().getFullYear()} Sri Basaveswara School</p><p class="mt-2"><a href="#" onclick="navigateTo('login')" class="hover:underline">Staff Login</a> | <a href="#" onclick="toggleTheme()" class="hover:underline">Toggle Theme</a></p></footer>
                </div>
            </div>
        `,
        certificate: (student, isPreview = false) => {
            const totalMarks = student.subjects.reduce((sum, sub) => sum + Number(sub.marks), 0);
            const percentage = (student.subjects.length > 0) ? (totalMarks / (student.subjects.length * 100) * 100).toFixed(2) : 0;
            const overallGrade = percentage >= 90 ? 'A1' : percentage >= 80 ? 'A2' : 'B1';
            const qrData = `RollNo:${student.RollNumber},Name:${student.Name},Class:${student.Class},Percentage:${percentage}%`;
            const qr = qrcode(4, 'L'); qr.addData(qrData); qr.make();
            const qrCodeImage = qr.createDataURL(4);
            const previewIdSuffix = isPreview ? '-preview' : '';
            return `<div class="bg-white dark:bg-gray-800 p-2 md:p-4 rounded-xl shadow-2xl certificate fade-in"><div class="p-4 md:p-6 rounded-t-lg certificate-banner" style="background-image: url('${state.schoolAssets.banner}')" id="cert-banner${previewIdSuffix}"><div class="flex justify-between items-center"><img src="${state.schoolAssets.logo}" alt="School Logo" class="h-16 md:h-20" id="cert-logo${previewIdSuffix}"><div class="text-center flex-1 mx-4"><h2 class="font-playfair text-xl md:text-3xl font-bold">ST. XAVIER'S SCHOOL</h2><p class="text-xs md:text-base">Annual Examination Report Card</p></div></div></div><div class="p-4 md:p-6"><div class="flex justify-between items-start mb-4"><div class="text-sm"><p><strong>Student Name:</strong> ${student.Name}</p><p><strong>Roll Number:</strong> ${student.RollNumber}</p><p><strong>Class:</strong> ${student.Class}</p><p><strong>Date of Birth:</strong> ${isPreview ? 'DD-MM-YYYY' : new Date(student.DOB).toLocaleDateString('en-GB')}</p></div><div class="text-center"><div class="w-20 h-20 md:w-24 md:h-24 bg-white p-1 rounded-md shadow-md"><img src="${qrCodeImage}" class="w-full h-full"></div><div class="flex items-center justify-center mt-1 text-green-600 text-xs"><svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>Verified</div></div></div><table class="w-full text-left text-sm mb-4"><thead class="bg-gray-100 dark:bg-gray-800"><tr><th class="p-2 font-semibold">Subject</th><th class="p-2 font-semibold text-center">Marks</th><th class="p-2 font-semibold text-center">Grade</th></tr></thead><tbody>${student.subjects.map(s => `<tr class="border-b dark:border-gray-700"><td class="p-2">${s.name}</td><td class="p-2 text-center">${s.marks}</td><td class="p-2 text-center">${s.grade}</td></tr>`).join('')}</tbody></table><div class="mt-6 flex justify-between items-end"><p class="text-xs">Date of Issue: ${isPreview ? 'DD-MM-YYYY' : new Date().toLocaleDateString('en-GB')}</p><div class="text-center"><img src="${state.schoolAssets.signature}" alt="Principal's Signature" class="h-12 md:h-16 mx-auto" id="cert-signature${previewIdSuffix}"><p class="border-t-2 border-gray-400 dark:border-gray-500 pt-1 mt-1 text-xs">Principal's Signature</p></div></div></div></div>${!isPreview ? `<div class="mt-6 text-right"><button onclick="navigateTo('studentPortal')" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg">Back</button></div>` : ''}`;
        },
        login: () => `<div class="min-h-screen flex items-center justify-center p-4"><div class="w-full max-w-sm mx-auto bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg fade-in"><img src="${state.schoolAssets.logo}" alt="School Logo" class="h-20 mx-auto mb-6"><h1 class="text-2xl font-bold text-center mb-6">Secure Staff Portal</h1><form id="login-form" class="space-y-4"><input type="text" name="username" required placeholder="Username" class="w-full p-3 rounded-lg border"><input type="password" name="password" required placeholder="Password" class="w-full p-3 rounded-lg border"><button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg">Login</button></form><p class="text-center mt-4"><a href="#" onclick="navigateTo('studentPortal')" class="text-sm hover:underline">Back to Student Portal</a></p></div></div>`,
        dashboard: () => {
            const navLinks = {
                admin: [{ id: 'users', label: 'User Management', icon: '👥' }, { id: 'exams', label: 'Exam & Subject', icon: '📝' }, { id: 'approvals', label: 'Approval Queue', icon: '📬' }, { id: 'branding', label: 'Branding', icon: '🎨' }, { id: 'logs', label: 'Activity Log', icon: '📋' }],
                principal: [{ id: 'approvals', label: 'Approval Queue', icon: '📬' }, { id: 'data_view', label: 'View Student Data', icon: '📊' }],
                'vice-principal': [{ id: 'approvals', label: 'Approval Queue', icon: '📬' }, { id: 'data_view', label: 'View Student Data', icon: '📊' }],
                teacher: [{ id: 'marks_entry', label: 'Marks Entry', icon: '✏️' }, { id: 'add_student', label: 'Add Student', icon: '🧑‍🎓' }],
                staff: [{ id: 'data_view', label: 'View Student Data', icon: '📊' }]
            };
            return `<div class="flex h-screen"><aside class="w-64 bg-white dark:bg-gray-800 border-r dark:border-gray-700 flex flex-col"><div class="p-4 text-center border-b dark:border-gray-700"><img src="${state.schoolAssets.logo}" alt="School Logo" class="h-16 mx-auto mb-2" id="dashboard-logo"><h2 class="text-xl font-bold capitalize">${state.user.role.replace('-', ' ')} Panel</h2><p class="text-sm text-gray-500 dark:text-gray-400">${state.user.name}</p></div><nav id="dashboard-nav" class="flex-1 mt-4">${navLinks[state.user.role].map(link => `<a href="#" onclick="renderDashboardView('${link.id}')" data-view="${link.id}" class="flex items-center px-6 py-3 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"><span class="mr-3">${link.icon}</span> ${link.label}</a>`).join('')}</nav><div class="p-4 border-t dark:border-gray-700"><button onclick="toggleTheme()" class="w-full text-left flex items-center text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded mb-2"><span class="mr-3 light-mode-icon">☀️</span><span class="mr-3 dark-mode-icon">🌙</span> Toggle Theme</button><button onclick="logout()" class="w-full bg-red-600 text-white p-2 rounded-lg">Logout</button></div></aside><main id="main-content" class="flex-1 p-8 overflow-y-auto"></main></div>`;
        },
        adminBranding: () => `<h1 class="text-3xl font-bold mb-6">Branding Management</h1><div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow"><h3 class="font-semibold text-xl mb-4">Upload Assets</h3><p class="text-sm text-gray-500 mb-6">Upload new images to update the portal's appearance. Changes are reflected in the live preview.</p><div class="space-y-6"><div><label class="block text-sm font-medium mb-2">School Logo</label><input type="file" id="logo-upload" accept="image/*" class="w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"></div><div><label class="block text-sm font-medium mb-2">Principal's Signature (PNG)</label><input type="file" id="signature-upload" accept="image/png" class="w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"></div><div><label class="block text-sm font-medium mb-2">Certificate Banner</label><input type="file" id="banner-upload" accept="image/*" class="w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"></div></div></div><div class="bg-gray-100 dark:bg-gray-900 p-4 rounded-lg"><h3 class="font-semibold text-xl mb-4 text-center">Live Preview</h3><div class="scale-75 origin-top mx-auto">${templates.certificate({ Name: 'Student Name', RollNumber: 'XXX', Class: 'X', DOB: '2010-01-01', subjects: [{name: 'Sample Subject', marks: 95, grade: 'A1'}] }, true)}</div></div></div>`,
        adminUsers: (users) => `
            <h1 class="text-3xl font-bold mb-6">User Management</h1>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md">
                    <h3 class="font-semibold mb-4">Existing Staff</h3>
                    <div class="max-h-96 overflow-y-auto"><table class="w-full text-left"><thead><tr class="border-b"><th class="p-2">Username</th><th class="p-2">Full Name</th><th class="p-2">Role</th><th class="p-2">Actions</th></tr></thead><tbody>${users.map(u => `<tr class="border-b"><td class="p-2">${u.Username}</td><td class="p-2">${u.FullName}</td><td class="p-2 capitalize">${u.Role}</td><td class="p-2"><button onclick="showEditUserModal('${u.Username}')" class="text-blue-500 hover:underline text-sm">Edit</button> | <button onclick="handleDeleteUser('${u.Username}')" class="text-red-500 hover:underline text-sm">Delete</button></td></tr>`).join('')}</tbody></table></div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <h3 class="font-semibold mb-4">Add New Staff Member</h3>
                    <form id="add-user-form" class="space-y-4">
                        <input name="fullName" required placeholder="Full Name" class="w-full p-2 rounded border">
                        <input name="username" required placeholder="Username" class="w-full p-2 rounded border">
                        <input name="password" required placeholder="Password" class="w-full p-2 rounded border">
                        <select name="role" class="w-full p-2 rounded border"><option value="teacher">Teacher</option><option value="principal">Principal</option><option value="vice-principal">Vice-Principal</option><option value="staff">Staff</option><option value="admin">Admin</option></select>
                        <button type="submit" class="w-full bg-green-600 text-white p-2 rounded">Add User</button>
                    </form>
                </div>
            </div>
        `,
        adminExams: (examList, subjectList) => `
            <h1 class="text-3xl font-bold mb-6">Exam & Subject Management</h1>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <h3 class="font-semibold mb-4">Manage Exams</h3>
                    <div class="max-h-60 overflow-y-auto border rounded p-2 mb-4"><ul class="list-disc list-inside">${examList.map(exam => `<li>${exam}</li>`).join('')}</ul></div>
                    <form id="add-exam-form" class="space-y-4"><input name="examName" required placeholder="New Exam Name" class="w-full p-2 rounded border"><button type="submit" class="w-full bg-green-600 text-white p-2 rounded">Create Exam</button></form>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <h3 class="font-semibold mb-4">Manage Subjects</h3>
                     <div class="max-h-60 overflow-y-auto border rounded p-2 mb-4"><ul class="list-disc list-inside">${subjectList.map(sub => `<li>${sub}</li>`).join('')}</ul></div>
                    <form id="add-subject-form" class="space-y-4"><input name="subjectName" required placeholder="New Subject Name" class="w-full p-2 rounded border"><button type="submit" class="w-full bg-green-600 text-white p-2 rounded">Create Subject</button></form>
                </div>
            </div>
        `,
        teacherAddStudent: () => `
            <h1 class="text-3xl font-bold mb-6">Add New Student</h1>
            <div class="max-w-xl bg-white dark:bg-gray-800 p-8 rounded-lg shadow-md">
                <h3 class="font-semibold mb-4">Enter Student Details</h3>
                <p class="text-sm text-gray-500 mb-4">The new student record will be sent for approval by the Principal and Admin before being added to the system.</p>
                <form id="add-student-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input name="Name" required placeholder="Full Name" class="w-full p-2 rounded border">
                        <input name="RollNumber" required placeholder="Roll Number" class="w-full p-2 rounded border">
                        <input type="date" name="DOB" required class="w-full p-2 rounded border">
                        <input name="Class" required placeholder="Class (e.g., Class 10A)" class="w-full p-2 rounded border">
                        <input name="FatherName" placeholder="Father's Name" class="w-full p-2 rounded border">
                        <input name="MotherName" placeholder="Mother's Name" class="w-full p-2 rounded border">
                    </div>
                    <input type="email" name="Email" required placeholder="Parent's Email for Notifications" class="w-full p-2 rounded border">
                    <button type="submit" class="w-full bg-indigo-600 text-white p-3 rounded-lg mt-4">Submit for Approval</button>
                </form>
            </div>
        `,
        teacherMarksEntry: (students, examList, subjectList) => { return `<h1 class="text-3xl font-bold mb-6">Marks Entry</h1><div class="flex items-center mb-4"><label class="mr-2">Exam Session:</label><select id="exam-session-select" class="p-2 rounded-lg border">${examList.map(name => `<option value="${name}">${name}</option>`).join('')}</select></div><div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md"><div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="border-b dark:border-gray-700"><th class="p-2">Roll No</th><th class="p-2">Name</th>${subjectList.map(s => `<th class="p-2">${s}</th>`).join('')}</tr></thead><tbody id="marks-table-body"></tbody></table></div></div><button onclick="submitMarksForApproval()" class="mt-6 bg-indigo-600 text-white py-2 px-6 rounded-lg">Submit for Approval</button>`; },
        principalApprovals: (approvals) => `<h1 class="text-3xl font-bold mb-6">Approval Queue</h1>${approvals.length === 0 ? '<p>No pending approvals.</p>' : ''}<div class="space-y-4">${approvals.map(a => `<div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow"><div class="flex justify-between items-start"><div><p><strong>Request ID:</strong> ${a.ID}</p><p><strong>Type:</strong> <span class="font-semibold">${a.RequestType}</span> | <strong>By:</strong> ${a.Requester}</p></div><div class="text-right text-sm"><p>Principal: <span class="font-bold capitalize ${a.PrincipalStatus === 'approved' ? 'text-green-500' : a.PrincipalStatus === 'rejected' ? 'text-red-500' : ''}">${a.PrincipalStatus}</span></p><p>Admin: <span class="font-bold capitalize ${a.AdminStatus === 'approved' ? 'text-green-500' : a.AdminStatus === 'rejected' ? 'text-red-500' : ''}">${a.AdminStatus}</span></p></div></div><details class="mt-2"><summary class="cursor-pointer">View Details</summary><pre class="bg-gray-100 dark:bg-gray-700 p-2 rounded mt-1 text-sm">${JSON.stringify(JSON.parse(a.DetailsJSON), null, 2)}</pre></details>${a.FinalStatus === 'pending' ? `<div class="mt-2 flex gap-2"><button onclick="handleApproval('${a.ID}', false)" class="bg-red-600 text-white px-3 py-1 rounded">Reject</button><button onclick="handleApproval('${a.ID}', true)" class="bg-green-600 text-white px-3 py-1 rounded">Approve</button></div>` : ''}</div>`).join('')}</div>`,
        principalDataView: (students, examList, subjectList) => `<h1 class="text-3xl font-bold mb-6">View Student Data</h1><div class="flex items-center mb-4"><label class="mr-2">Exam Session:</label><select id="exam-session-select" class="p-2 rounded-lg border">${examList.map(name => `<option value="${name}">${name}</option>`).join('')}</select></div><div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md"><div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="border-b dark:border-gray-700"><th class="p-2">Roll No</th><th class="p-2">Name</th>${subjectList.map(s => `<th class="p-2">${s}</th>`).join('')}</tr></thead><tbody id="marks-table-body"></tbody></table></div></div>`,
        adminLogs: (logs) => `<h1 class="text-3xl font-bold mb-6">Activity Log</h1><div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md"><table class="w-full text-left text-sm"><thead><tr class="border-b dark:border-gray-700"><th class="p-2">Timestamp</th><th class="p-2">Type</th><th class="p-2">Details</th></tr></thead><tbody>${logs.map(l => `<tr class="border-b dark:border-gray-700"><td class="p-2">${new Date(l.Timestamp).toLocaleString()}</td><td class="p-2">${l.Type}</td><td class="p-2">${l.DetailsJSON}</td></tr>`).join('')}</tbody></table></div>`,
        modal: ({ title, body }) => `<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4"><div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md modal-content transform scale-95 fade-in"><div class="p-6 border-b dark:border-gray-700"><h3 class="text-xl font-semibold">${title}</h3></div><div class="p-6">${body}</div><div class="p-4 bg-gray-50 dark:bg-gray-700/50 flex justify-end"><button onclick="closeModal()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">OK</button></div></div></div>`,
    };

    // --- RENDER & CONTROL FLOW ---
    function render() {
        document.getElementById('app').innerHTML = templates[state.currentPage]();
        const setup = { studentPortal: setupStudentPortal, login: setupLogin, dashboard: setupDashboard };
        setup[state.currentPage]();
        applyTheme();
    }

    async function setupDashboard() {
        try {
            state.dashboardData = await apiCall('getDashboardData');
            const defaultViews = { admin: 'users', principal: 'approvals', 'vice-principal': 'approvals', teacher: 'marks_entry', staff: 'data_view' };
            renderDashboardView(defaultViews[state.user.role]);
        } catch (error) { document.getElementById('main-content').innerHTML = `<p class="text-red-500">Failed to load dashboard data.</p>`; }
    }
    
    function renderDashboardView(viewId) {
        state.currentDashboardView = viewId;
        const mainContent = document.getElementById('main-content');
        document.querySelectorAll('#dashboard-nav a').forEach(link => {
            link.classList.remove('bg-gray-100', 'dark:bg-gray-700');
            if(link.dataset.view === viewId) link.classList.add('bg-gray-100', 'dark:bg-gray-700');
        });
        
        const { students, exams, examList, subjectList, approvals, logs, users } = state.dashboardData;
        const viewRenderers = {
            'branding': () => { mainContent.innerHTML = templates.adminBranding(); setupBrandingUploads(); },
            'users': () => { mainContent.innerHTML = templates.adminUsers(users); document.getElementById('add-user-form').addEventListener('submit', (e) => handleManageUser(e, 'add')); },
            'exams': () => { mainContent.innerHTML = templates.adminExams(examList, subjectList); document.getElementById('add-exam-form').addEventListener('submit', handleAddExam); document.getElementById('add-subject-form').addEventListener('submit', handleAddSubject); },
            'marks_entry': () => { mainContent.innerHTML = templates.teacherMarksEntry(students, examList, subjectList); document.getElementById('exam-session-select').addEventListener('change', () => populateMarksTable(students, exams, subjectList, false)); populateMarksTable(students, exams, subjectList, false); },
            'add_student': () => { mainContent.innerHTML = templates.teacherAddStudent(); document.getElementById('add-student-form').addEventListener('submit', handleAddStudent); },
            'approvals': () => mainContent.innerHTML = templates.principalApprovals(approvals),
            'logs': () => mainContent.innerHTML = templates.adminLogs(logs),
            'data_view': () => { mainContent.innerHTML = templates.principalDataView(students, examList, subjectList); document.getElementById('exam-session-select').addEventListener('change', () => populateMarksTable(students, exams, subjectList, true)); populateMarksTable(students, exams, subjectList, true); },
        };
        viewRenderers[viewId]();
    }
    
    // --- ACTION HANDLERS ---
    async function handleManageUser(e, operation, username = null) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const userData = Object.fromEntries(formData.entries());
        if(username) userData.username = username;
        
        try {
            const action = operation === 'add' ? 'addUser' : operation === 'edit' ? 'editUser' : 'deleteUser';
            const result = await apiCall(action, 'POST', { userData });
            showModal('Success', result.message);
            closeModal();
            state.dashboardData = await apiCall('getDashboardData');
            renderDashboardView('users');
        } catch(error) { /* Handled by apiCall */ }
    }

    function showEditUserModal(username) {
        const user = state.dashboardData.users.find(u => u.Username === username);
        const body = `
            <form id="edit-user-form" class="space-y-4">
                <p><strong>Username:</strong> ${user.Username}</p>
                <input name="fullName" required value="${user.FullName}" placeholder="Full Name" class="w-full p-2 rounded border">
                <input name="password" required value="${user.Password}" placeholder="Password" class="w-full p-2 rounded border">
                <select name="role" class="w-full p-2 rounded border">
                    <option value="teacher" ${user.Role === 'teacher' ? 'selected' : ''}>Teacher</option>
                    <option value="principal" ${user.Role === 'principal' ? 'selected' : ''}>Principal</option>
                    <option value="vice-principal" ${user.Role === 'vice-principal' ? 'selected' : ''}>Vice-Principal</option>
                    <option value="staff" ${user.Role === 'staff' ? 'selected' : ''}>Staff</option>
                    <option value="admin" ${user.Role === 'admin' ? 'selected' : ''}>Admin</option>
                </select>
                <button type="submit" class="w-full bg-blue-600 text-white p-2 rounded">Save Changes</button>
            </form>
        `;
        showModal(`Edit User: ${username}`, body);
        document.getElementById('edit-user-form').addEventListener('submit', (e) => handleManageUser(e, 'edit', username));
    }

    function handleDeleteUser(username) {
        if(confirm(`Are you sure you want to delete user "${username}"? This action cannot be undone.`)) {
            apiCall('deleteUser', 'POST', { userData: { username } })
                .then(result => {
                    showModal('Success', result.message);
                    return apiCall('getDashboardData');
                })
                .then(data => {
                    state.dashboardData = data;
                    renderDashboardView('users');
                })
                .catch(err => {});
        }
    }

    async function handleAddExam(e) {
        e.preventDefault();
        const examName = e.target.elements.examName.value;
        if (!examName) return;
        try {
            const result = await apiCall('manageExam', 'POST', { examName });
            showModal('Success', result.message);
            state.dashboardData = await apiCall('getDashboardData');
            renderDashboardView('exams');
        } catch(error) { /* Handled by apiCall */ }
    }

    async function handleAddSubject(e) {
        e.preventDefault();
        const subjectName = e.target.elements.subjectName.value;
        if (!subjectName) return;
        try {
            const result = await apiCall('manageSubject', 'POST', { subjectName });
            showModal('Success', result.message);
            state.dashboardData = await apiCall('getDashboardData');
            renderDashboardView('exams');
        } catch(error) { /* Handled by apiCall */ }
    }
    
    async function handleAddStudent(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const studentData = Object.fromEntries(formData.entries());
        try {
            const result = await apiCall('addStudent', 'POST', { studentData });
            showModal('Success', result.message);
            e.target.reset();
        } catch(error) { /* Handled by apiCall */ }
    }

    async function setupStudentPortal() {
        document.getElementById('result-form').addEventListener('submit', async e => {
            e.preventDefault();
            const btn = document.getElementById('submit-btn');
            const btnText = document.getElementById('submit-btn-text');
            const spinner = document.getElementById('submit-spinner');
            btnText.textContent = 'Checking...';
            spinner.classList.remove('hidden');
            btn.disabled = true;
            try {
                const rollNo = document.getElementById('roll-no').value;
                const dob = document.getElementById('dob').value;
                const url = `${SCRIPT_URL}?action=getStudentResult&rollNo=${rollNo}&dob=${dob}`;
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.status === 'success') {
                    document.getElementById('result-form-section').classList.add('hidden');
                    document.getElementById('result-display-section').innerHTML = templates.certificate(result.data);
                    document.getElementById('result-display-section').classList.remove('hidden');
                } else {
                    showModal('Error', `<p>${result.message}</p>`);
                }
            } catch (error) {
                showModal('Error', 'An error occurred while fetching results.');
            } finally {
                btnText.textContent = 'Get Result';
                spinner.classList.add('hidden');
                btn.disabled = false;
            }
        });
    }

    async function setupLogin() {
        document.getElementById('login-form').addEventListener('submit', async e => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const { username, password } = Object.fromEntries(formData.entries());
            try {
                const result = await apiCall('login', 'POST', { username, password });
                state.user = { name: result.name, role: result.role };
                navigateTo('dashboard');
            } catch (error) { /* Handled by apiCall */ }
        });
    }

    function setupBrandingUploads() {
        const handleUpload = (fileInputId, assetKey, targetImgId, targetBgId) => {
            document.getElementById(fileInputId).addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const imageUrl = event.target.result;
                        state.schoolAssets[assetKey] = imageUrl;
                        if(targetImgId) {
                            document.getElementById(targetImgId).src = imageUrl;
                            if(assetKey === 'logo') {
                                document.getElementById('main-logo')?.setAttribute('src', imageUrl);
                                document.getElementById('dashboard-logo')?.setAttribute('src', imageUrl);
                            }
                        }
                        if(targetBgId) {
                            document.getElementById(targetBgId).style.backgroundImage = `url('${imageUrl}')`;
                        }
                    };
                    reader.readAsDataURL(file);
                }
            });
        };
        handleUpload('logo-upload', 'logo', 'cert-logo-preview');
        handleUpload('signature-upload', 'signature', 'cert-signature-preview');
        handleUpload('banner-upload', 'banner', null, 'cert-banner-preview');
    }

    function populateMarksTable(students, exams, subjectList, isReadOnly) {
        const session = document.getElementById('exam-session-select').value;
        const tableBody = document.getElementById('marks-table-body');
        tableBody.innerHTML = students.map(student => {
            const getMark = (subject) => exams.find(e => e.ExamName === session && e.RollNumber == student.RollNumber && e.Subject === subject)?.Marks || '';
            const readOnlyAttr = isReadOnly ? 'readonly class="w-20 p-1 rounded bg-gray-100 dark:bg-gray-700"' : 'class="w-20 p-1 rounded border"';
            return `<tr class="border-b dark:border-gray-700" data-rollno="${student.RollNumber}"><td class="p-2">${student.RollNumber}</td><td class="p-2">${student.Name}</td>${subjectList.map(s => `<td class="p-2"><input type="number" data-subject="${s}" value="${getMark(s)}" ${readOnlyAttr}></td>`).join('')}</tr>`;
        }).join('');
    }

    function navigateTo(page) { state.currentPage = page; render(); }
    function logout() { state.user = null; state.dashboardData = {}; navigateTo('login'); }
    async function submitMarksForApproval() {
        const changes = [];
        document.querySelectorAll('#marks-table-body tr').forEach(row => {
            row.querySelectorAll('input[type="number"]').forEach(input => {
                if (input.value !== '' && !input.readOnly) {
                    changes.push({ rollNo: row.dataset.rollno, subject: input.dataset.subject, marks: Number(input.value) });
                }
            });
        });
        if (changes.length === 0) return showModal('No Changes', 'No marks were entered or changed.');
        const changeRequest = { type: 'UpdateMarks', requester: state.user.name, data: { examSession: document.getElementById('exam-session-select').value, changes } };
        try {
            const result = await apiCall('submitForApproval', 'POST', { changeRequest });
            showModal('Success', result.message);
        } catch(error) { /* Handled by apiCall */ }
    }
    async function handleApproval(changeId, isApproved) {
        try {
            const result = await apiCall('authorizeChange', 'POST', { changeId, role: state.user.role, isApproved });
            showModal('Success', result.message);
            state.dashboardData = await apiCall('getDashboardData');
            renderDashboardView(state.currentDashboardView);
        } catch(error) { /* Handled by apiCall */ }
    }
    function toggleTheme() { state.theme = state.theme === 'light' ? 'dark' : 'light'; applyTheme(); }
    function applyTheme() { document.documentElement.classList.toggle('dark', state.theme === 'dark'); }
    function showModal(title, body) { document.getElementById('modal-container').innerHTML = templates.modal({ title, body }); setTimeout(() => document.querySelector('.modal-content')?.classList.replace('scale-95', 'scale-100'), 10); }
    function closeModal() {
        const content = document.querySelector('.modal-content');
        if (content) {
            content.classList.replace('scale-100', 'scale-95');
            setTimeout(() => document.getElementById('modal-container').innerHTML = '', 300);
        }
    }

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', render);
    </script>
</body>
</html>
